934be4a28bf1eb8b983fc1489aa071c1
const Apartment = require('../models/apartment.model');
const NodeCache = require('node-cache');

// Initialize cache with a standard TTL of 10 minutes
const cache = new NodeCache({
  stdTTL: 600
});

// Query builder for apartment filters
const buildApartmentQuery = req => {
  // Handle user role-based access
  if (req.user) {
    if (req.user.role === 'admin') {
      // Admin sees all listings
      return {};
    } else if (req.user.role === 'agent') {
      // Agent sees public listings and their own private listings
      return {
        $or: [{
          isPublic: true
        }, {
          owner: req.user._id
        }]
      };
    } else {
      // Regular users see only public listings
      return {
        isPublic: true
      };
    }
  } else {
    // Unauthenticated users see only public listings
    return {
      isPublic: true
    };
  }
};

// @desc    Get all apartments
// @route   GET /api/apartments
// @access  Public
const getApartments = async (req, res) => {
  try {
    const query = buildApartmentQuery(req);

    // Execute query with pagination
    const page = parseInt(req.query.page, 10) || 1;
    const limit = parseInt(req.query.limit, 10) || 10;
    const skip = (page - 1) * limit;
    const apartments = await Apartment.find(query).select('title price location bedrooms bathrooms area amenities images owner status isPublic createdAt').populate('owner', 'name email').skip(skip).limit(limit).sort({
      createdAt: -1
    });
    const total = await Apartment.countDocuments(query);
    const pages = Math.ceil(total / limit);
    return res.json({
      apartments,
      page,
      pages,
      total
    });
  } catch (error) {
    console.error('Error in getApartments:', error);
    return res.status(500).json({
      message: 'Error fetching apartments',
      error: error.message
    });
  }
};

// @desc    Get single apartment
// @route   GET /api/apartments/:id
// @access  Public
const getApartment = async (req, res, next) => {
  try {
    const apartment = await Apartment.findById(req.params.id).populate('owner', 'name email');
    if (!apartment) {
      return res.status(404).json({
        error: 'Apartment not found'
      });
    }

    // Check if the apartment is public or if the user has access
    if (!apartment.isPublic && (!req.user || apartment.owner._id.toString() !== req.user._id.toString() && req.user.role !== 'admin' && req.user.role !== 'agent')) {
      return res.status(403).json({
        error: 'Not authorized to view this apartment'
      });
    }
    return res.json(apartment);
  } catch (error) {
    return next(error);
  }
};

// @desc    Create apartment
// @route   POST /api/apartments
// @access  Private
const createApartment = async (req, res, next) => {
  try {
    // Only admin and agent can create listings
    if (req.user.role !== 'admin' && req.user.role !== 'agent') {
      return res.status(403).json({
        error: 'Only admins and agents can create listings'
      });
    }
    const apartment = await Apartment.create({
      ...req.body,
      owner: req.user._id
    });
    const populatedApartment = await Apartment.findById(apartment._id).populate('owner', 'name email');
    return res.status(201).json(populatedApartment);
  } catch (error) {
    return next(error);
  }
};

// @desc    Update apartment
// @route   PUT /api/apartments/:id
// @access  Private
const updateApartment = async (req, res) => {
  try {
    // IMPORTANT: Find the apartment to ensure it exists and check permissions before updating
    const apartment = await Apartment.findById(req.params.id);
    if (!apartment) {
      return res.status(404).json({
        error: 'Apartment not found'
      });
    }

    // IMPORTANT: Only the owner or an admin can update
    if (apartment.owner.toString() !== req.user._id.toString() && req.user.role !== 'admin') {
      return res.status(403).json({
        error: 'Not authorized to update this apartment'
      });
    }

    // IMPORTANT: Only admins can change isPublic status
    if (req.body.isPublic !== undefined && req.user.role !== 'admin') {
      return res.status(403).json({
        error: 'Only admins can change the public status of listings'
      });
    }

    // TODO: Add more granular field-level update permissions if needed in the future

    // Update apartment
    const updatedApartment = await Apartment.findByIdAndUpdate(req.params.id, {
      $set: req.body
    }, {
      new: true,
      runValidators: true
    }).populate('owner', 'name email');
    if (!updatedApartment) {
      return res.status(404).json({
        error: 'Apartment not found'
      });
    }
    return res.json(updatedApartment);
  } catch (error) {
    // Handle validation errors
    if (error.name === 'ValidationError') {
      return res.status(400).json({
        error: 'Validation error',
        details: error.message
      });
    }
    // Handle other errors
    console.error('Error in updateApartment:', error);
    return res.status(500).json({
      error: 'Error updating apartment',
      details: error.message
    });
  }
};

// @desc    Delete apartment
// @route   DELETE /api/apartments/:id
// @access  Private
const deleteApartment = async (req, res, next) => {
  try {
    const apartment = await Apartment.findById(req.params.id);
    if (!apartment) {
      return res.status(404).json({
        error: 'Apartment not found'
      });
    }

    // Check ownership and role
    if (apartment.owner.toString() !== req.user._id.toString() && req.user.role !== 'admin') {
      return res.status(403).json({
        error: 'Not authorized to delete this apartment'
      });
    }
    await apartment.deleteOne();
    return res.json({
      message: 'Apartment removed'
    });
  } catch (error) {
    return next(error);
  }
};
module.exports = {
  getApartments,
  getApartment,
  createApartment,
  updateApartment,
  deleteApartment
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBcGFydG1lbnQiLCJyZXF1aXJlIiwiTm9kZUNhY2hlIiwiY2FjaGUiLCJzdGRUVEwiLCJidWlsZEFwYXJ0bWVudFF1ZXJ5IiwicmVxIiwidXNlciIsInJvbGUiLCIkb3IiLCJpc1B1YmxpYyIsIm93bmVyIiwiX2lkIiwiZ2V0QXBhcnRtZW50cyIsInJlcyIsInF1ZXJ5IiwicGFnZSIsInBhcnNlSW50IiwibGltaXQiLCJza2lwIiwiYXBhcnRtZW50cyIsImZpbmQiLCJzZWxlY3QiLCJwb3B1bGF0ZSIsInNvcnQiLCJjcmVhdGVkQXQiLCJ0b3RhbCIsImNvdW50RG9jdW1lbnRzIiwicGFnZXMiLCJNYXRoIiwiY2VpbCIsImpzb24iLCJlcnJvciIsImNvbnNvbGUiLCJzdGF0dXMiLCJtZXNzYWdlIiwiZ2V0QXBhcnRtZW50IiwibmV4dCIsImFwYXJ0bWVudCIsImZpbmRCeUlkIiwicGFyYW1zIiwiaWQiLCJ0b1N0cmluZyIsImNyZWF0ZUFwYXJ0bWVudCIsImNyZWF0ZSIsImJvZHkiLCJwb3B1bGF0ZWRBcGFydG1lbnQiLCJ1cGRhdGVBcGFydG1lbnQiLCJ1bmRlZmluZWQiLCJ1cGRhdGVkQXBhcnRtZW50IiwiZmluZEJ5SWRBbmRVcGRhdGUiLCIkc2V0IiwibmV3IiwicnVuVmFsaWRhdG9ycyIsIm5hbWUiLCJkZXRhaWxzIiwiZGVsZXRlQXBhcnRtZW50IiwiZGVsZXRlT25lIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbImFwYXJ0bWVudC5jb250cm9sbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEFwYXJ0bWVudCA9IHJlcXVpcmUoJy4uL21vZGVscy9hcGFydG1lbnQubW9kZWwnKTtcbmNvbnN0IE5vZGVDYWNoZSA9IHJlcXVpcmUoJ25vZGUtY2FjaGUnKTtcblxuLy8gSW5pdGlhbGl6ZSBjYWNoZSB3aXRoIGEgc3RhbmRhcmQgVFRMIG9mIDEwIG1pbnV0ZXNcbmNvbnN0IGNhY2hlID0gbmV3IE5vZGVDYWNoZSh7IHN0ZFRUTDogNjAwIH0pO1xuXG4vLyBRdWVyeSBidWlsZGVyIGZvciBhcGFydG1lbnQgZmlsdGVyc1xuY29uc3QgYnVpbGRBcGFydG1lbnRRdWVyeSA9IChyZXEpID0+IHtcbiAgLy8gSGFuZGxlIHVzZXIgcm9sZS1iYXNlZCBhY2Nlc3NcbiAgaWYgKHJlcS51c2VyKSB7XG4gICAgaWYgKHJlcS51c2VyLnJvbGUgPT09ICdhZG1pbicpIHtcbiAgICAgIC8vIEFkbWluIHNlZXMgYWxsIGxpc3RpbmdzXG4gICAgICByZXR1cm4ge307XG4gICAgfSBlbHNlIGlmIChyZXEudXNlci5yb2xlID09PSAnYWdlbnQnKSB7XG4gICAgICAvLyBBZ2VudCBzZWVzIHB1YmxpYyBsaXN0aW5ncyBhbmQgdGhlaXIgb3duIHByaXZhdGUgbGlzdGluZ3NcbiAgICAgIHJldHVybiB7XG4gICAgICAgICRvcjogW3sgaXNQdWJsaWM6IHRydWUgfSwgeyBvd25lcjogcmVxLnVzZXIuX2lkIH1dLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gUmVndWxhciB1c2VycyBzZWUgb25seSBwdWJsaWMgbGlzdGluZ3NcbiAgICAgIHJldHVybiB7IGlzUHVibGljOiB0cnVlIH07XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIC8vIFVuYXV0aGVudGljYXRlZCB1c2VycyBzZWUgb25seSBwdWJsaWMgbGlzdGluZ3NcbiAgICByZXR1cm4geyBpc1B1YmxpYzogdHJ1ZSB9O1xuICB9XG59O1xuXG4vLyBAZGVzYyAgICBHZXQgYWxsIGFwYXJ0bWVudHNcbi8vIEByb3V0ZSAgIEdFVCAvYXBpL2FwYXJ0bWVudHNcbi8vIEBhY2Nlc3MgIFB1YmxpY1xuY29uc3QgZ2V0QXBhcnRtZW50cyA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHF1ZXJ5ID0gYnVpbGRBcGFydG1lbnRRdWVyeShyZXEpO1xuXG4gICAgLy8gRXhlY3V0ZSBxdWVyeSB3aXRoIHBhZ2luYXRpb25cbiAgICBjb25zdCBwYWdlID0gcGFyc2VJbnQocmVxLnF1ZXJ5LnBhZ2UsIDEwKSB8fCAxO1xuICAgIGNvbnN0IGxpbWl0ID0gcGFyc2VJbnQocmVxLnF1ZXJ5LmxpbWl0LCAxMCkgfHwgMTA7XG4gICAgY29uc3Qgc2tpcCA9IChwYWdlIC0gMSkgKiBsaW1pdDtcblxuICAgIGNvbnN0IGFwYXJ0bWVudHMgPSBhd2FpdCBBcGFydG1lbnQuZmluZChxdWVyeSlcbiAgICAgIC5zZWxlY3QoXG4gICAgICAgICd0aXRsZSBwcmljZSBsb2NhdGlvbiBiZWRyb29tcyBiYXRocm9vbXMgYXJlYSBhbWVuaXRpZXMgaW1hZ2VzIG93bmVyIHN0YXR1cyBpc1B1YmxpYyBjcmVhdGVkQXQnXG4gICAgICApXG4gICAgICAucG9wdWxhdGUoJ293bmVyJywgJ25hbWUgZW1haWwnKVxuICAgICAgLnNraXAoc2tpcClcbiAgICAgIC5saW1pdChsaW1pdClcbiAgICAgIC5zb3J0KHsgY3JlYXRlZEF0OiAtMSB9KTtcblxuICAgIGNvbnN0IHRvdGFsID0gYXdhaXQgQXBhcnRtZW50LmNvdW50RG9jdW1lbnRzKHF1ZXJ5KTtcbiAgICBjb25zdCBwYWdlcyA9IE1hdGguY2VpbCh0b3RhbCAvIGxpbWl0KTtcblxuICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICBhcGFydG1lbnRzLFxuICAgICAgcGFnZSxcbiAgICAgIHBhZ2VzLFxuICAgICAgdG90YWwsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gZ2V0QXBhcnRtZW50czonLCBlcnJvcik7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0Vycm9yIGZldGNoaW5nIGFwYXJ0bWVudHMnLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcbiAgfVxufTtcblxuLy8gQGRlc2MgICAgR2V0IHNpbmdsZSBhcGFydG1lbnRcbi8vIEByb3V0ZSAgIEdFVCAvYXBpL2FwYXJ0bWVudHMvOmlkXG4vLyBAYWNjZXNzICBQdWJsaWNcbmNvbnN0IGdldEFwYXJ0bWVudCA9IGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGFwYXJ0bWVudCA9IGF3YWl0IEFwYXJ0bWVudC5maW5kQnlJZChyZXEucGFyYW1zLmlkKS5wb3B1bGF0ZSgnb3duZXInLCAnbmFtZSBlbWFpbCcpO1xuXG4gICAgaWYgKCFhcGFydG1lbnQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnQXBhcnRtZW50IG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdGhlIGFwYXJ0bWVudCBpcyBwdWJsaWMgb3IgaWYgdGhlIHVzZXIgaGFzIGFjY2Vzc1xuICAgIGlmIChcbiAgICAgICFhcGFydG1lbnQuaXNQdWJsaWMgJiZcbiAgICAgICghcmVxLnVzZXIgfHxcbiAgICAgICAgKGFwYXJ0bWVudC5vd25lci5faWQudG9TdHJpbmcoKSAhPT0gcmVxLnVzZXIuX2lkLnRvU3RyaW5nKCkgJiZcbiAgICAgICAgICByZXEudXNlci5yb2xlICE9PSAnYWRtaW4nICYmXG4gICAgICAgICAgcmVxLnVzZXIucm9sZSAhPT0gJ2FnZW50JykpXG4gICAgKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ05vdCBhdXRob3JpemVkIHRvIHZpZXcgdGhpcyBhcGFydG1lbnQnIH0pO1xuICAgIH1cblxuICAgIHJldHVybiByZXMuanNvbihhcGFydG1lbnQpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHJldHVybiBuZXh0KGVycm9yKTtcbiAgfVxufTtcblxuLy8gQGRlc2MgICAgQ3JlYXRlIGFwYXJ0bWVudFxuLy8gQHJvdXRlICAgUE9TVCAvYXBpL2FwYXJ0bWVudHNcbi8vIEBhY2Nlc3MgIFByaXZhdGVcbmNvbnN0IGNyZWF0ZUFwYXJ0bWVudCA9IGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIC8vIE9ubHkgYWRtaW4gYW5kIGFnZW50IGNhbiBjcmVhdGUgbGlzdGluZ3NcbiAgICBpZiAocmVxLnVzZXIucm9sZSAhPT0gJ2FkbWluJyAmJiByZXEudXNlci5yb2xlICE9PSAnYWdlbnQnKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ09ubHkgYWRtaW5zIGFuZCBhZ2VudHMgY2FuIGNyZWF0ZSBsaXN0aW5ncycgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgYXBhcnRtZW50ID0gYXdhaXQgQXBhcnRtZW50LmNyZWF0ZSh7XG4gICAgICAuLi5yZXEuYm9keSxcbiAgICAgIG93bmVyOiByZXEudXNlci5faWQsXG4gICAgfSk7XG5cbiAgICBjb25zdCBwb3B1bGF0ZWRBcGFydG1lbnQgPSBhd2FpdCBBcGFydG1lbnQuZmluZEJ5SWQoYXBhcnRtZW50Ll9pZCkucG9wdWxhdGUoXG4gICAgICAnb3duZXInLFxuICAgICAgJ25hbWUgZW1haWwnXG4gICAgKTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cygyMDEpLmpzb24ocG9wdWxhdGVkQXBhcnRtZW50KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICByZXR1cm4gbmV4dChlcnJvcik7XG4gIH1cbn07XG5cbi8vIEBkZXNjICAgIFVwZGF0ZSBhcGFydG1lbnRcbi8vIEByb3V0ZSAgIFBVVCAvYXBpL2FwYXJ0bWVudHMvOmlkXG4vLyBAYWNjZXNzICBQcml2YXRlXG5jb25zdCB1cGRhdGVBcGFydG1lbnQgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgdHJ5IHtcbiAgICAvLyBJTVBPUlRBTlQ6IEZpbmQgdGhlIGFwYXJ0bWVudCB0byBlbnN1cmUgaXQgZXhpc3RzIGFuZCBjaGVjayBwZXJtaXNzaW9ucyBiZWZvcmUgdXBkYXRpbmdcbiAgICBjb25zdCBhcGFydG1lbnQgPSBhd2FpdCBBcGFydG1lbnQuZmluZEJ5SWQocmVxLnBhcmFtcy5pZCk7XG5cbiAgICBpZiAoIWFwYXJ0bWVudCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdBcGFydG1lbnQgbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICAvLyBJTVBPUlRBTlQ6IE9ubHkgdGhlIG93bmVyIG9yIGFuIGFkbWluIGNhbiB1cGRhdGVcbiAgICBpZiAoYXBhcnRtZW50Lm93bmVyLnRvU3RyaW5nKCkgIT09IHJlcS51c2VyLl9pZC50b1N0cmluZygpICYmIHJlcS51c2VyLnJvbGUgIT09ICdhZG1pbicpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnTm90IGF1dGhvcml6ZWQgdG8gdXBkYXRlIHRoaXMgYXBhcnRtZW50JyB9KTtcbiAgICB9XG5cbiAgICAvLyBJTVBPUlRBTlQ6IE9ubHkgYWRtaW5zIGNhbiBjaGFuZ2UgaXNQdWJsaWMgc3RhdHVzXG4gICAgaWYgKHJlcS5ib2R5LmlzUHVibGljICE9PSB1bmRlZmluZWQgJiYgcmVxLnVzZXIucm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAuc3RhdHVzKDQwMylcbiAgICAgICAgLmpzb24oeyBlcnJvcjogJ09ubHkgYWRtaW5zIGNhbiBjaGFuZ2UgdGhlIHB1YmxpYyBzdGF0dXMgb2YgbGlzdGluZ3MnIH0pO1xuICAgIH1cblxuICAgIC8vIFRPRE86IEFkZCBtb3JlIGdyYW51bGFyIGZpZWxkLWxldmVsIHVwZGF0ZSBwZXJtaXNzaW9ucyBpZiBuZWVkZWQgaW4gdGhlIGZ1dHVyZVxuXG4gICAgLy8gVXBkYXRlIGFwYXJ0bWVudFxuICAgIGNvbnN0IHVwZGF0ZWRBcGFydG1lbnQgPSBhd2FpdCBBcGFydG1lbnQuZmluZEJ5SWRBbmRVcGRhdGUoXG4gICAgICByZXEucGFyYW1zLmlkLFxuICAgICAgeyAkc2V0OiByZXEuYm9keSB9LFxuICAgICAgeyBuZXc6IHRydWUsIHJ1blZhbGlkYXRvcnM6IHRydWUgfVxuICAgICkucG9wdWxhdGUoJ293bmVyJywgJ25hbWUgZW1haWwnKTtcblxuICAgIGlmICghdXBkYXRlZEFwYXJ0bWVudCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdBcGFydG1lbnQgbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzLmpzb24odXBkYXRlZEFwYXJ0bWVudCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgLy8gSGFuZGxlIHZhbGlkYXRpb24gZXJyb3JzXG4gICAgaWYgKGVycm9yLm5hbWUgPT09ICdWYWxpZGF0aW9uRXJyb3InKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ1ZhbGlkYXRpb24gZXJyb3InLCBkZXRhaWxzOiBlcnJvci5tZXNzYWdlIH0pO1xuICAgIH1cbiAgICAvLyBIYW5kbGUgb3RoZXIgZXJyb3JzXG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gdXBkYXRlQXBhcnRtZW50OicsIGVycm9yKTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0Vycm9yIHVwZGF0aW5nIGFwYXJ0bWVudCcsIGRldGFpbHM6IGVycm9yLm1lc3NhZ2UgfSk7XG4gIH1cbn07XG5cbi8vIEBkZXNjICAgIERlbGV0ZSBhcGFydG1lbnRcbi8vIEByb3V0ZSAgIERFTEVURSAvYXBpL2FwYXJ0bWVudHMvOmlkXG4vLyBAYWNjZXNzICBQcml2YXRlXG5jb25zdCBkZWxldGVBcGFydG1lbnQgPSBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBhcGFydG1lbnQgPSBhd2FpdCBBcGFydG1lbnQuZmluZEJ5SWQocmVxLnBhcmFtcy5pZCk7XG5cbiAgICBpZiAoIWFwYXJ0bWVudCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdBcGFydG1lbnQgbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBvd25lcnNoaXAgYW5kIHJvbGVcbiAgICBpZiAoYXBhcnRtZW50Lm93bmVyLnRvU3RyaW5nKCkgIT09IHJlcS51c2VyLl9pZC50b1N0cmluZygpICYmIHJlcS51c2VyLnJvbGUgIT09ICdhZG1pbicpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnTm90IGF1dGhvcml6ZWQgdG8gZGVsZXRlIHRoaXMgYXBhcnRtZW50JyB9KTtcbiAgICB9XG5cbiAgICBhd2FpdCBhcGFydG1lbnQuZGVsZXRlT25lKCk7XG5cbiAgICByZXR1cm4gcmVzLmpzb24oeyBtZXNzYWdlOiAnQXBhcnRtZW50IHJlbW92ZWQnIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHJldHVybiBuZXh0KGVycm9yKTtcbiAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGdldEFwYXJ0bWVudHMsXG4gIGdldEFwYXJ0bWVudCxcbiAgY3JlYXRlQXBhcnRtZW50LFxuICB1cGRhdGVBcGFydG1lbnQsXG4gIGRlbGV0ZUFwYXJ0bWVudCxcbn07XG4iXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLFNBQVMsR0FBR0MsT0FBTyxDQUFDLDJCQUEyQixDQUFDO0FBQ3RELE1BQU1DLFNBQVMsR0FBR0QsT0FBTyxDQUFDLFlBQVksQ0FBQzs7QUFFdkM7QUFDQSxNQUFNRSxLQUFLLEdBQUcsSUFBSUQsU0FBUyxDQUFDO0VBQUVFLE1BQU0sRUFBRTtBQUFJLENBQUMsQ0FBQzs7QUFFNUM7QUFDQSxNQUFNQyxtQkFBbUIsR0FBSUMsR0FBRyxJQUFLO0VBQ25DO0VBQ0EsSUFBSUEsR0FBRyxDQUFDQyxJQUFJLEVBQUU7SUFDWixJQUFJRCxHQUFHLENBQUNDLElBQUksQ0FBQ0MsSUFBSSxLQUFLLE9BQU8sRUFBRTtNQUM3QjtNQUNBLE9BQU8sQ0FBQyxDQUFDO0lBQ1gsQ0FBQyxNQUFNLElBQUlGLEdBQUcsQ0FBQ0MsSUFBSSxDQUFDQyxJQUFJLEtBQUssT0FBTyxFQUFFO01BQ3BDO01BQ0EsT0FBTztRQUNMQyxHQUFHLEVBQUUsQ0FBQztVQUFFQyxRQUFRLEVBQUU7UUFBSyxDQUFDLEVBQUU7VUFBRUMsS0FB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